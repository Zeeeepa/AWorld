FROM ghcr.io/open-webui/open-webui:main as base

RUN mkdir /app/aworld

RUN apt-get update && apt-get install -y wget unzip openssh-client procps nodejs npm

ARG PIP_OPTIONS='-i https://pypi.tuna.tsinghua.edu.cn/simple'

RUN pip install -U pip pysocks ${PIP_OPTIONS}

# Install Chrome Driver
RUN cd /app/aworld/ && \
    wget https://storage.googleapis.com/chrome-for-testing-public/136.0.7103.92/linux64/chromedriver-linux64.zip && \
    unzip chromedriver-linux64.zip && \
    rm chromedriver-linux64.zip
ENV CHROME_DRIVER_PATH=/app/aworld/chromedriver-linux64/chromedriver

# Install AWorld Dependencies
COPY ./aworld/requirements.txt /app/aworld/aworld/requirements.txt
RUN pip install -r /app/aworld/aworld/requirements.txt --resume-retries 5 ${PIP_OPTIONS}

COPY ./examples/gaia/requirements.txt /app/aworld/examples/gaia/requirements.txt
# Install Gaia
RUN pip install -r /app/aworld/examples/gaia/requirements.txt --resume-retries 5 ${PIP_OPTIONS}


FROM base as runner

COPY . /app/aworld

# Create GAIA benchmark directory
RUN mkdir -p /app/aworld/gaia-benchmark/fs && \
    mkdir -p /app/aworld/gaia-benchmark/logs

# # Patch OpenWebUI
# RUN cd /app/aworld/examples/gaia/openwebui-patch && \
#     python patch_openwebui.py

ENV ENABLE_OLLAMA_API=False
ENV ENABLE_OPENAI_API=False
ENV ENABLE_DIRECT_CONNECTIONS=False
ENV ENABLE_EVALUATION_ARENA_MODELS=False
ENV ENABLE_TITLE_GENERATION=False
ENV ENABLE_AUTOCOMPLETE_GENERATION=False
ENV ENABLE_TAGS_GENERATION=False
